variant: fcos
version: 1.4.0
passwd:
  users:
    - name: tomster
      ssh_authorized_keys: 
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDbVNnQVs6SVW1GvQQ7FE6afs08LMtTNmDIPtoT3+Aqa7I3HOZRgWpqh3kIz3OTOCs2zl5JHCJDaANvadjGFcdtSI+zy7bozpj5TJWGDnGkH3Rp2SBBRK6twjjrN9nbTJ2ihlkXEOA2e3SDFXEkwu6t0fLZelBUk3FWnbK/xPmsRUuEF90oxpXpZIPeFbE4nNK3HarNPL+XzA2xzSqrwNk9ICCJ9MS3OcnPpWIQR3LKLEgyPFKwy4K6WzQyNvr5uFAcV9Zrq9TM93HSOUdtFFXcDeAEu76cQorsgAyU7XbAPqSza780qF/kHhQ+Hb4q1Wmyk62nAu7dT86lujpzIWXOdFJZyb3WWjP21qe7bk8A1S5Q9lfto/bo0Rs2wHbBRtoxMrb8DTC3EtErjN/IXMZrqMZpj3hNiNxP3PYKXLWb6AbuWjQO5d4Tu4vv4QWKGyJwvkI55V0sI9a2lLODAK+x9z4K7cbGLFHqdEFCLkq7sDU3zd9q68//M/LQO3AO9sMpd8jHDg0xdgdfh5dP6grUDypz1h/HtXCT+w3Ka2geitqoTMv6y0WO1vT+c97mvbjf24rwoLiPe7qVPnxKTRPNRH1vhmOLeZsQva2ATXBCR/J+Xn4JzSWOt17N/s5ldvfD+d6FrYzDNw664efaXMIWCbVJtlKvas0I9iM2VYRM7Q==
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDcmfm4RKkVC02QrF6ajGVVlbO3+AiVVyfoO4jbUjNbBNarVNgOHNC2lyxo3DJG33uKg74/e6fwj2mr2qW7Bq/yefmMqZrwY6ZyBDOOnkmsaMjX3Q5dJVRvHaYDShseJEBVtALVZFPyYQhdCdCEI/pO1Oeh+bDgLFinWoKAx6Fau8ArjbCsU4WfmgTUQae8AkE5e+uj+2T7Nq195CgfWEnAcKTKEYTr+6Y5a8L/w6ugto41bXvbwWhgogMT7epkcsfSF14M5hi0kBTawmzSi6HsqnAs4PWadaN0IMtfZJ/ZdpNw2QjdDKReGc3AcvEUQU9840RgVmXLp0JT5kdHJZabYcpPaDRwTw3A/oNIEZCzOKve8j4aFrf003etUn7Vq5wchyqyRrk2KRnK61v8BOtF7REs5jw/hQ1PdbsGewhxmGQy3gJ670BS1apQDvrZVHUqIsl3SGcykBBQvLu0F5erZ3ENPAk0wb++ygBtqsoF0wV9rv+L/VEh7233/TUQbH6K2ggZg5SvQnjUA4JqnBcSPf8kMlEGCU+8yeGSF086vL3gpVF6VpvUa34Sh+RbLGtNPVcoTSa2yLwSHdU0NmA9Lj/0M3+ty+uK4pBU86zIIAmyB9NBN/TcpeR7PVi3J991EbVLZgwzAK7S/LAmE6vWLG1IoQbDDN7QCB9XWiFiaQ==
      groups:
        - wheel
        - sudo
systemd:
  units:
    - name: postinst.service
      enabled: true
      contents: |
        [Unit]
        Description=Initial System Setup
        # We run after `systemd-machine-id-commit.service` to ensure that
        # `ConditionFirstBoot=true` services won't rerun on the next boot.
        After=systemd-machine-id-commit.service
        After=network-online.target
        # We run before `zincati.service` to avoid conflicting rpm-ostree
        # transactions.
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/rpm-ostree install fail2ban firewalld tuned qemu-guest-agent
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/usr/bin/sed 's/nullok//g' /etc/pam.d/system-auth
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/Whonix/security-misc/master/etc/modprobe.d/30_security-misc.conf -o /etc/modprobe.d/30_security-misc.conf
        ExecStart=/bin/systemctl --no-block reboot

        [Install]
        WantedBy=multi-user.target
    - name: postinst2.service
      enabled: true
      contents: |
        [Unit]
        Description=Initial System Setup Part 2
        # We run this after the packages have been overlayed
        After=network-online.target
        ConditionPathExists=!/var/lib/%N.stamp
        ConditionPathExists=/var/lib/postinst.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/docker run --detach --privileged --name watchtower --restart unless-stopped -v /var/run/docker.sock:/var/run/docker.sock -v /etc/localtime:/etc/localtime:ro containrrr/watchtower --schedule "0 5 0 * * 1"
        ExecStart=/bin/touch /var/lib/%N.stamp

        [Install]
        WantedBy=multi-user.target
    - name: setsebool.service
      enabled: true
      contents: |
        [Service]
        Type=oneshot 
        ExecStart=/usr/sbin/setsebool container_use_cephfs off
        ExecStart=/usr/sbin/setsebool virt_use_nfs off
        ExecStart=/usr/sbin/setsebool virt_use_samba off
        RemainAfterExit=yes
        [Install]
        WantedBy=multi-user.target
    - name: docker.service
      enabled: true
    - name: fstrim.timer
      enabled: true
    - name: systemd-oomd.service
      enabled: true
    - name: rpm-ostree-countme.timer
      enabled: false
      mask: true
storage:
  files:
    - path: /etc/ssh/sshd_config.d/60-disable-GSSAPI.conf
      contents:
        inline: |
          GSSAPIAuthentication no
    - path: /etc/zincati/config.d/51-rollout-wariness.toml
      contents:
        inline: |
          [identity]
          rollout_wariness = 1
    - path: /etc/zincati/config.d/55-updates-strategy.toml
      contents:
        inline: |
          [updates]
          strategy = "periodic"
          [updates.periodic]
          time_zone = "localtime"
          [[updates.periodic.window]]
          days = [ "Sun" ]
          start_time = "0:00"
          length_minutes = 60
    - path: /etc/fail2ban/jail.local
      contents:
        inline: |
          [DEFAULT]
          # Maximum 3 failures:
          maxentry = 3
          # Ban hosts for one hour:
          bantime = 3600
          # Override /etc/fail2ban/jail.d/00-firewalld.conf:
          banaction = iptables-multiport
          [sshd]
          enabled = true
    - path: /etc/tuned/active_profile
      overwrite: true
      contents:
        inline: |
          virtual-guest
    - path: /etc/tuned/profile_mode
      overwrite: true
      contents:
        inline: |
          manual
    - path: /etc/systemd/zram-generator.conf
      overwrite: true
      contents:
        inline: |
          # This config file enables a /dev/zram0 device with the default settings
          [zram0]
          zram-fraction = 1
          max-zram-size = 8192
    - path: /etc/security/limits.d/30-disable-coredump.conf
      overwrite: true
      contents: 
        inline: | 
          * hard core 0
    - path: /etc/ssh/ssh_config.d/60-disable-GSSAPI.conf
      overwrite: true
      contents: 
        inline: | 
          GSSAPIAuthentication no
    - path: /etc/sysctl.d/20-silence-audit.conf
      contents:
        inline: |
          # Raise console message logging level from DEBUG (7) to WARNING (4)
          # so that audit messages don't get interspersed on the console that
          # may frustrate a user trying to interactively log in.
          kernel.printk=4
  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/America/New_York
    - path: /etc/systemd/system/multi-user.target.wants/tuned.service
      target: /usr/lib/systemd/system/tuned.service
    - path: /etc/systemd/system/multi-user.target.wants/fail2ban.service
      target: /usr/lib/systemd/system/fail2ban.service
    - path: /etc/systemd/system/kdump.service.target
      target: /dev/null
kernel_arguments:
  should_exist:
    - spectre_v2=on
    - spec_store_bypass_disable=on
    - l1tf=full,force
    - mds=full,nosmt
    - tsx=off 
    - tsx_async_abort=full,nosmt
    - kvm.nx_huge_pages=force
    - nosmt=force
    - l1d_flush=on
    - mmio_stale_data=full,nosmt
    - random.trust_bootloader=off
    - random.trust_cpu=off
    - intel_iommu=on 
    - amd_iommu=on
    - efi=disable_early_pci_dma
    - iommu.passthrough=0
    - iommu.strict=1
    - slab_nomerge
    - init_on_alloc=1 
    - init_on_free=1
    - pti=on
    - vsyscall=none
    - page_alloc.shuffle=1
    - randomize_kstack_offset=on
    - extra_latent_entropy
    - debugfs=off
    - sysctl.kernel.core_pattern=|/bin/false
    - sysctl.kernel.dmesg_restrict=1
    - sysctl.fs.protected_fifos=2
    - sysctl.fs.protected_regular=2
    - sysctl.fs.protected_symlinks=1
    - sysctl.fs.protected_hardlinks=1
    - sysctl.net.core.bpf_jit_harden=2
    - sysctl.kernel.kexec_load_disabled=1
    - sysctl.kernel.kptr_restrict=2
    - sysctl.vm.mmap_rnd_bits=32
    - sysctl.vm.mmap_rnd_compat_bits=16
    - sysctl.kernel.yama.ptrace_scope=3
    - sysctl.fs.suid_dumpable=0
    - sysctl.kernel.randomize_va_space=2
    - sysctl.net.ipv4.tcp_rfc1337=1
    - sysctl.net.ipv4.conf.all.accept_redirects=0
    - sysctl.net.ipv4.conf.default.accept_redirects=0
    - sysctl.net.ipv4.conf.all.secure_redirects=0
    - sysctl.net.ipv4.conf.default.secure_redirects=0
    - sysctl.net.ipv6.conf.all.accept_redirects=0
    - sysctl.net.ipv6.conf.default.accept_redirects=0
    - sysctl.net.ipv4.conf.all.send_redirects=0
    - sysctl.net.ipv4.conf.default.send_redirects=0
    - sysctl.net.ipv4.icmp_echo_ignore_all=1
    - sysctl.net.ipv6.icmp.echo_ignore_all=1
    - sysctl.net.ipv4.icmp_ignore_bogus_error_responses=1
    - sysctl.net.ipv4.tcp_syncookies=1
    - sysctl.net.ipv4.conf.all.accept_source_route=0
    - sysctl.net.ipv4.conf.default.accept_source_route=0
    - sysctl.net.ipv6.conf.all.accept_source_route=0
    - sysctl.net.ipv6.conf.default.accept_source_route=0
    - sysctl.net.ipv4.conf.default.rp_filter=1
    - sysctl.net.ipv4.conf.all.rp_filter=1
    - sysctl.net.ipv4.tcp_timestamps=0
    - sysctl.kernel.sysrq=132
    - sysctl.dev.tty.ldisc_autoload=0
    - sysctl.vm.unprivileged_userfaultfd=0
    - sysctl.vm.swappiness=1
    - sysctl.kernel.perf_event_paranoid=3
    - sysctl.net.ipv6.conf.all.accept_ra=0
    - sysctl.net.ipv6.conf.default.accept_ra=0

